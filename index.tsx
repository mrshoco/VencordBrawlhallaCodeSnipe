/*
 * Vencord, a Discord client mod
 * Copyright (c) 2025 Vendicated and contributors
 * SPDX-License-Identifier: GPL-3.0-or-later
 */

import { definePluginSettings } from "@api/Settings";
import ErrorBoundary from "@components/ErrorBoundary";
import { openModal } from "@utils/modal";
import definePlugin, { OptionType } from "@utils/types";
import type { Message } from "@vencord/discord-types";
import { findComponentByCodeLazy } from "@webpack";
import { ChannelStore, Menu, Popout, useRef, useState } from "@webpack/common";
import type { PropsWithChildren } from "react";

import { modalSounds } from "./sounds/modalSound";

const HeaderBarIcon = findComponentByCodeLazy(".HEADER_BAR_BADGE_TOP:", '.iconBadge,"top"');

interface IMessageCreate {
    type: "MESSAGE_CREATE";
    optimistic: boolean;
    isPushNotification: boolean;
    channelId: string;
    message: Message;
}
const RegexCode = /\b[A-Z0-9]{6}-[A-Z0-9]{6}\b/;
let lastCodesCollection: Record<string, string[]> = {};

const settings = definePluginSettings({
    openOnRecieve: {
        type: OptionType.BOOLEAN,
        description: "Open if code",
        default: true,
    },
    playSound: {
        type: OptionType.BOOLEAN,
        description: "Play a sound on alert",
        default: false,
    },
    soundToPlay: {
        type: OptionType.STRING,
        description: "What audio to play",
        default: "default",
    }
});

function BrawlhallaPopout(onClose: () => void) {
    return (
        <Menu.Menu
            navId="vc-brawlhalla"
            onClose={onClose}
        >
            <Menu.MenuItem
                id="vc-brawlhalla-notifications"
                label="Open Code Modal"
                action={openLastCodeModal}
            />
        </Menu.Menu>
    );
}

function BrawlhallaPopoutIcon() {
    return (
        <svg
            width={24}
            height={24}
            viewBox="0 0 1600 1600"
            xmlns="http://www.w3.org/2000/svg"
        >
            <path
                d="m 795.33333,1524.4207 c -7.3263,-1.8786 -12.39634,-6.1104 -28.81846,-24.054 -9.81651,-10.726 -28.29831,-30.9464 -41.07066,-44.9343 -12.77234,-13.9877 -26.87234,-29.3353 -31.33333,-34.1056 -4.46099,-4.7701 -14.11088,-15.2651 -21.44421,-23.3219 -7.33334,-8.0568 -17.53334,-19.1649 -22.66667,-24.6848 -5.13333,-5.5198 -21.33263,-23.225 -35.99843,-39.3448 -14.6658,-16.1198 -30.32068,-33.2086 -34.78864,-37.9753 -4.46794,-4.7667 -19.11129,-20.6667 -32.54076,-35.3333 -13.42946,-14.6667 -27.17457,-29.6515 -30.54469,-33.2996 -6.12032,-6.6251 -6.31764,-6.7144 -168.79415,-76.3868 -89.46666,-38.3646 -168.06666,-71.898 -174.66666,-74.5184 -12.8806,-5.1142 -17.98711,-8.9319 -21.30807,-15.9303 -3.38571,-7.1349 -0.1092,-60.90449 6.04476,-99.19827 8.83579,-54.98189 28.46001,-107.2989 56.06777,-149.47333 10.25619,-15.66765 18.27935,-26.01947 34.09104,-43.98569 l 12.43174,-14.1257 29.6697,-10.7697 c 16.31835,-5.92334 52.76972,-19.27355 81.00306,-29.66714 28.23333,-10.39358 74.93676,-27.54074 103.7854,-38.1048 28.84862,-10.56404 53.37537,-19.72406 54.50388,-20.35561 1.64538,-0.9208 32.51738,-80.41036 53.92682,-138.85136 6.93715,-18.9362 5.856,-35.27465 -3.23422,-48.87645 -4.50844,-6.74602 -11.37386,-12.41292 -83.42524,-68.86162 -21.34482,-16.7226 -40.02499,-31.95093 -41.51151,-33.84073 -1.48652,-1.8898 -3.36344,-5.88959 -4.17095,-8.88841 -1.38446,-5.14154 0.0408,-10.73572 24.99548,-98.11083 14.82447,-51.90553 27.65922,-94.43899 29.18194,-96.70685 1.49505,-2.22664 5.09505,-5.33354 8,-6.9042 5.6339,-3.04616 282.22574,-79.144243 287.66368,-79.144243 1.11126,0 65.79221,17.414425 143.73544,38.698723 149.03521,40.69769 147.94341,40.34637 152.39501,49.03686 1.0136,1.97876 13.6749,45.00339 28.1363,95.61027 25.3954,88.86969 26.2401,92.21077 24.7306,97.81671 -0.91,3.37942 -3.6133,7.9278 -6.4711,10.88754 -2.6995,2.79586 -28.9082,23.80956 -58.2415,46.69714 -29.3334,22.88756 -55.6168,43.78252 -58.4078,46.43325 -10.7573,10.21697 -16.4647,29.39996 -13.0198,43.76016 2.6312,10.96773 55.6347,150.02993 57.6008,151.12385 1.0047,0.55899 60.7693,22.6501 132.8102,49.09135 72.041,26.44124 132.4736,48.85575 134.2948,49.80999 3.5628,1.86672 17.4499,16.94614 30.319,32.92225 37.2914,46.2946 63.6417,108.25193 74.3328,174.77857 3.7682,23.44852 5.0881,36.74744 6.7149,67.65577 1.3648,25.9329 1.3153,27.1951 -1.2667,32.256 -2.8532,5.5929 -9.206,11.1174 -14.7116,12.7935 -1.8333,0.5581 -79.8401,33.8004 -173.3485,73.8718 -169.844,72.7837 -170.0214,72.8637 -176.1275,79.4733 -3.3618,3.639 -17.1,18.6163 -30.5295,33.283 -13.4294,14.6666 -28.0752,30.5666 -32.5461,35.3333 -4.4709,4.7667 -20.1258,21.8655 -34.78862,37.9975 -14.66285,16.1318 -30.85975,33.8389 -35.99308,39.3488 -5.13333,5.51 -21.93333,23.784 -37.33333,40.6089 -15.4,16.8248 -35.2,38.4356 -44,48.0237 -8.8,9.5883 -24.296,26.5188 -34.43555,37.6238 -10.13956,11.1048 -20.33956,21.0873 -22.66667,22.1834 -5.03205,2.3703 -12.5212,3.5859 -16.23112,2.6346 z m 23.39979,-81.754 c 9.72373,-10.6334 23.4876,-25.6334 30.58639,-33.3334 7.09878,-7.7 56.55904,-61.7 109.91168,-120 53.35261,-58.3 99.20171,-107.5286 101.88681,-109.397 2.6851,-1.8684 68.482,-30.5829 146.2153,-63.81 77.7334,-33.2271 141.8047,-60.8498 142.3808,-61.3838 0.5762,-0.534 -38.0832,-12.7156 -85.9098,-27.0702 l -86.9575,-26.0994 -29.4234,13.0496 c -16.1829,7.1772 -54.6234,24.2643 -85.4234,37.9714 -30.8,13.707 -65,28.8966 -76,33.7545 l -20,8.8326 -74.01785,98.7017 c -44.29763,59.0703 -75.81047,99.9098 -78.48234,101.7104 -8.37596,5.6446 -18.6258,5.6431 -27.00522,0 -2.68019,-1.8062 -34.09435,-42.5247 -78.4533,-101.6898 l -73.9832,-98.6773 -105.36238,-46.8446 -105.36238,-46.8447 -87.04209,26.1249 c -47.87315,14.3687 -86.57315,26.5471 -86,27.063 0.57315,0.516 63.14209,27.4863 139.04209,59.9339 75.9,32.4476 141.3,60.7488 145.33334,62.8916 6.32541,3.3604 25.01777,23.216 136,144.4634 70.76666,77.3121 129.05373,140.4377 129.5268,140.279 0.47308,-0.1586 8.81592,-8.9885 18.53965,-19.6218 z m 47.06247,-297.0608 c 35.63206,-47.5167 66.15481,-87.68 67.82832,-89.2517 1.67352,-1.5717 17.14276,-9.0794 34.37609,-16.6838 17.23333,-7.6044 64.1192,-28.4043 104.1909,-46.22191 l 72.8576,-32.39573 -2.5141,-8.85971 c -16.9429,-59.70837 -38.304,-133.73529 -38.699,-134.1114 -0.2761,-0.2629 -48.8021,-21.91062 -107.8354,-48.10604 -59.03333,-26.19541 -109.19889,-49.02236 -111.47903,-50.72656 -2.28013,-1.70418 -5.18386,-5.2863 -6.45274,-7.96026 -3.13804,-6.61292 -53.14218,-330.87022 -52.3649,-339.56591 0.59535,-6.66041 5.12338,-14.019 10.99299,-17.86492 2.46388,-1.6144 43.934,-12.52088 85.80443,-22.56623 3.06296,-0.73485 3.14774,-1.09956 2.57117,-11.05962 -0.48819,-8.43304 -1.40601,-11.819 -5.06433,-18.6827 -4.0788,-7.65261 -15.82556,-20.21608 -18.90191,-20.21608 -0.69992,0 -19.36065,13.59288 -41.46829,30.2064 -50.78204,38.16186 -50.20364,37.79492 -59.5651,37.78862 -5.09016,-0.004 -8.79476,-0.8519 -11.8485,-2.7137 -2.44359,-1.48978 -23.21575,-16.78754 -46.16036,-33.99501 -22.94462,-17.20747 -42.33042,-31.28631 -43.07958,-31.28631 -3.15288,0 -14.85672,12.45855 -18.99144,20.21608 -3.6664,6.87887 -4.57576,10.2431 -5.06822,18.75012 -0.33008,5.70192 -0.23658,10.36714 0.20781,10.36714 1.76117,0 80.82797,20.05046 84.39177,21.40082 8.10555,3.07126 15.1429,13.24743 15.1429,21.89694 0,5.7406 -48.74694,324.35378 -50.8466,332.33682 -3.25159,12.36263 -0.24042,10.75702 -118.48674,63.17932 -59.76666,26.49644 -108.89396,48.38006 -109.17176,48.63026 -0.27781,0.25021 -9.65098,32.42762 -20.82929,71.50538 -13.85397,48.43147 -19.84796,71.32422 -18.82824,71.91039 0.82277,0.47297 47.69596,21.36865 104.16263,46.4348 56.46666,25.0662 104.0359,46.8519 105.70942,48.4127 1.67351,1.5608 32.19626,41.7151 67.82832,89.2318 C 769.83647,1193.1227 799.44448,1232 800,1232 c 0.55552,0 30.16353,-38.8773 65.79559,-86.3941 z M 663.70499,1009.6667 C 518.81044,937.01428 526.67147,941.72169 525.62383,926.97953 c -0.5316,-7.48062 -0.22628,-8.2814 14.09961,-36.97953 8.25767,-16.54205 16.31,-30.90429 18.46584,-32.93592 2.40597,-2.26733 46.71064,-22.65231 119.53691,-55 101.79514,-45.21497 116.5108,-51.39741 122.33776,-51.39741 5.82826,0 20.51296,6.17322 122.27988,51.40468 72.53637,32.2396 117.07917,52.74512 119.47297,55 2.1496,2.02489 10.2128,16.40801 18.4598,32.92865 14.3259,28.69813 14.6312,29.49891 14.0996,36.97953 -1.0477,14.74216 6.8134,10.03475 -138.08119,82.68717 -119.27973,59.8087 -130.16504,65 -136.29501,65 -6.12997,0 -17.01528,-5.1913 -136.29501,-65 z m 244.63164,-41.81302 c 58.84818,-29.4138 107.17647,-53.64363 107.39627,-53.84404 0.2198,-0.2004 -1.7929,-4.79532 -4.4726,-10.21091 L 1006.3881,893.9522 903.22051,848.1304 800.05288,802.30861 696.82747,848.15431 593.60204,894 l -4.86728,9.82263 c -2.677,5.40245 -4.68747,9.9866 -4.46768,10.18701 1.46041,1.33171 214.07123,107.19186 215.40288,107.25036 0.91848,0.04 49.81848,-23.99251 108.66667,-53.40632 z M 308,984.17128 l 96.66667,-29.02731 19.02965,-66.43122 c 10.46631,-36.53716 18.69745,-66.76343 18.29141,-67.16946 -0.40602,-0.40602 -35.6488,-5.08542 -78.31726,-10.39865 -60.9209,-7.58609 -77.99216,-9.31875 -79.503,-8.0692 -1.05819,0.87517 -5.79116,6.37849 -10.51772,12.22959 -36.54799,45.24342 -59.06114,102.42032 -67.6528,171.81852 C 204.89863,995.99513 204,1005.8693 204,1009.0661 c 0,5.6556 0.0989,5.7898 3.66667,4.9725 2.01666,-0.462 47.16666,-13.9023 100.33333,-29.86732 z m 1087.5465,18.48202 c -2.104,-29.64221 -10.6484,-71.23718 -20.2653,-98.6533 -6.4796,-18.47236 -20.9052,-48.38248 -30.5456,-63.33333 -7.7576,-12.03067 -23.6144,-32.72836 -28.2578,-36.88435 -2.3204,-2.07677 -7.4115,-1.60483 -80.128,7.42796 -42.7076,5.30511 -77.9709,9.96641 -78.363,10.35845 -0.392,0.39204 7.8506,30.59887 18.3169,67.1263 l 19.0296,66.41349 L 1294,984.7838 c 54.2667,16.3214 99.5065,29.722 100.5329,29.7791 1.5286,0.085 1.712,-2.0712 1.0136,-11.9096 z M 572.93597,729.22271 c 56.31855,-24.99418 102.89883,-45.92564 103.51174,-46.51438 0.97465,-0.9362 44.80965,-281.2331 44.86452,-286.88004 0.0169,-1.7384 -7.62738,-4.07553 -38.31223,-11.71342 l -38.33333,-9.54171 -48.55211,0.38009 -48.55211,0.38008 29.21878,22.81694 c 30.77452,24.03182 37.49721,30.3557 45.39533,42.70246 14.01693,21.91199 18.78619,50.95386 12.46963,75.93244 -3.39011,13.40607 -61.63146,167.87438 -65.02978,172.47262 -1.38561,1.87489 -4.86614,4.68226 -7.73452,6.23861 -2.86837,1.55636 -44.35796,17.15636 -92.19906,34.66667 -47.84111,17.51032 -86.99111,32.14962 -87,32.53181 -0.009,0.38219 19.33384,3.15375 42.98384,6.15903 23.65,3.00526 43.42118,5.54257 43.93597,5.63845 0.51479,0.0959 47.01479,-20.27547 103.33333,-45.26965 z m 602.73073,39.27185 c 22.9166,-2.79853 41.6599,-5.40468 41.6518,-5.79141 -0.01,-0.38674 -40.0385,-15.40315 -88.9563,-33.36982 -48.9178,-17.96666 -90.7287,-33.8687 -92.9131,-35.33786 -2.1844,-1.46916 -5.0123,-4.46916 -6.2842,-6.66667 -2.6951,-4.65625 -61.15006,-159.44544 -63.94577,-169.3288 -1.23698,-4.373 -1.86353,-13.08895 -1.82108,-25.33333 0.0583,-16.8159 0.42948,-19.72426 3.74368,-29.33334 4.50356,-13.05742 12.68138,-27.16142 20.78114,-35.84046 3.34242,-3.58148 19.22563,-16.78252 35.29593,-29.33566 l 29.2187,-22.82388 -48.5521,-0.38008 -48.55207,-0.38009 L 917,384.11487 c -27.42381,6.82617 -38.33333,10.07293 -38.33333,11.40832 0,3.03958 42.5485,279.45537 43.66617,283.67665 0.96656,3.65059 6.75627,6.42045 103.67876,49.60127 56.4633,25.15546 103.855,45.52034 105.3217,45.25824 1.4667,-0.2621 21.4167,-2.76624 44.3334,-5.56479 z M 621.94175,316.33333 c 2.09112,-20.47717 10.91446,-42.09057 23.44197,-57.4227 3.78508,-4.6325 6.6722,-8.58902 6.4158,-8.79227 -0.2564,-0.20327 -20.86619,-12.55173 -45.79952,-27.44107 -24.93333,-14.88932 -46.24803,-27.85334 -47.366,-28.80894 -1.57452,-1.34584 -3.30051,-1.41563 -7.65784,-0.30962 -5.49008,1.39354 -5.68769,1.64012 -8.22873,10.26788 -1.43196,4.86203 -9.61718,33.44006 -18.18935,63.50672 -8.57219,30.06667 -15.86875,55.41667 -16.21459,56.33334 -0.49689,1.31705 11.25554,1.66666 56.02519,1.66666 h 56.654 z m 469.28335,6 c -0.525,-1.65 -8.9067,-30.87788 -18.626,-64.95085 l -17.6714,-61.95085 -16.2133,-4.45702 -16.2133,-4.45702 -2.7822,3.53689 c -1.5301,1.94529 -18.1175,15.02884 -36.86083,29.07455 -18.7433,14.0457 -34.98676,26.2266 -36.09658,27.06868 -1.72924,1.31206 -1.254,2.36086 3.32298,7.33333 15.7491,17.10997 25.64252,39.30611 27.99265,62.80229 l 0.9002,9 h 56.60118 56.6012 z M 882.47016,231.98164 c 44.10808,-33.13908 80.19508,-60.64184 80.19332,-61.11725 -0.001,-0.47542 -13.05175,-4.39467 -29,-8.70946 -15.94824,-4.31478 -29.59681,-8.06182 -30.33015,-8.32676 -0.73333,-0.26492 -4.50418,5.76792 -8.37966,13.40631 -18.49996,36.46256 -47.20946,65.0754 -78.26902,78.00553 -14.25856,5.93586 -22.18733,5.48096 -38.01798,-2.1812 -32.60424,-15.7807 -61.36503,-46.82978 -77.915,-84.11417 -1.5935,-3.58988 -3.19464,-5.4708 -4.29695,-5.0478 -0.96636,0.37083 -17.66401,4.98264 -37.10587,10.24847 C 639.90699,169.41115 624,174.09475 624,174.55331 c 0,0.45856 20.34215,13.00457 45.20477,27.88004 40.2561,24.08545 49.8532,30.54026 87.66667,58.96282 23.35404,17.5541 43.12347,31.67395 43.93205,31.37744 0.80859,-0.2965 37.55859,-27.65289 81.66667,-60.79197 z m -75.85447,-37.28897 c 6.60875,-3.37152 20.35294,-16.07554 26.71216,-24.69054 8.06576,-10.92688 17.87711,-28.66956 16.55064,-29.92988 -1.56217,-1.48426 -45.74938,-13.40558 -49.68874,-13.40558 -3.91755,0 -48.49743,11.95065 -50.06824,13.42193 -1.32676,1.24271 8.50792,19.01785 16.55064,29.91353 9.05193,12.26287 26.98822,27.06466 33.04764,27.27227 0.94588,0.0324 4.04904,-1.12936 6.8959,-2.58173 z M 534.18301,1500.7136 c -13.23758,-4.7191 -20.28984,-19.4848 -15.4237,-32.2935 1.91949,-5.0525 43.45594,-46.9057 48.86453,-49.2373 12.45475,-5.3688 26.47913,0.4469 32.51501,13.4839 5.91404,12.7737 2.42718,19.849 -21.84861,44.3334 -24.45169,24.6619 -31.22764,28.305 -44.10723,23.7135 z m 513.07879,-1.3469 c -4.3743,-2.1888 -12.9821,-9.7478 -25.562,-22.4472 -24.30721,-24.5382 -27.74295,-31.5002 -21.83865,-44.2528 6.03585,-13.037 20.06025,-18.8527 32.51505,-13.4839 5.4085,2.3316 46.945,44.1848 48.8645,49.2373 1.956,5.1486 1.7885,13.4646 -0.3754,18.6435 -3.4371,8.2261 -14.8659,15.5701 -24.2702,15.5956 -1.506,0 -5.706,-1.4776 -9.3333,-3.2925 z M 458,1420.4265 c -1.46667,-0.2917 -4.00567,-0.8157 -5.64221,-1.1644 -4.29122,-0.9144 -12.45571,-8.5041 -14.5564,-13.5318 -2.57667,-6.1668 -2.23508,-15.6692 0.77108,-21.45 3.15444,-6.0662 40.45714,-43.1968 46.36132,-46.1476 4.93118,-2.4646 16.56976,-2.8203 20.82053,-0.6364 11.68473,6.0032 17.14459,18.1142 13.56619,30.0928 -1.65448,5.5384 -4.86903,9.351 -23.61783,28.0126 -11.93648,11.881 -23.20268,22.1431 -25.03601,22.8048 -5.18516,1.8714 -9.75196,2.5996 -12.66667,2.02 z m 674.081,-1.1884 c -4.8994,-1.4672 -9.6719,-5.5166 -27.7027,-23.5053 -18.8048,-18.7609 -22.0456,-22.6095 -23.6988,-28.1437 -3.5784,-11.9786 1.8814,-24.0896 13.5662,-30.0928 4.275,-2.1964 15.9098,-1.8228 20.8205,0.6685 5.9847,3.0361 43.2792,40.1199 46.3775,46.1155 4.6494,8.9972 3.0176,20.901 -3.8619,28.1721 -6.9456,7.3409 -15.7887,9.6941 -25.5008,6.7857 z m -762.74767,-82.0657 c -4.37052,-1.7377 -10.38678,-7.5134 -12.95866,-12.4407 -2.41427,-4.6252 -2.60827,-16.4922 -0.34242,-20.9461 0.87267,-1.7154 11.27242,-12.8851 23.11055,-24.8216 18.20759,-18.3589 22.46527,-21.984 27.63387,-23.5285 6.28649,-1.8785 14.0815,-1.2502 19.22333,1.5496 4.05829,2.2098 9.66291,8.5717 11.24851,12.7684 2.08541,5.5194 1.72728,15.1029 -0.7466,19.9794 -3.03612,5.9847 -40.11994,43.2792 -46.11546,46.3774 -5.35677,2.7682 -15.47772,3.2788 -21.05312,1.0621 z M 1210,1336.474 c -5.5203,-2.8787 -40.0927,-37.1318 -44.8157,-44.4017 -6.1737,-9.503 -5.1217,-21.7364 2.5672,-29.8537 6.961,-7.3489 15.7312,-9.6871 25.4778,-6.7926 5.2001,1.5442 9.4373,5.1674 28.2956,24.1951 20.354,20.537 22.289,22.9042 23.5094,28.7606 2.6082,12.5171 -3.6024,24.6407 -14.7878,28.8668 -5.4019,2.041 -15.5951,1.6511 -20.2465,-0.7745 z m -931.79308,-43.6819 c -9.07604,-3.3606 -14.69617,-10.3772 -16.28867,-20.3362 -0.68086,-4.2579 0.80358,-9.719 8.51146,-31.3131 10.36557,-29.0398 11.91664,-32.502 16.4618,-36.7458 7.49082,-6.9942 17.97698,-8.7299 27.26328,-4.5128 9.08122,4.1239 14.29946,12.8022 14.04077,23.3506 -0.17077,6.9636 -17.85155,55.8551 -22.31551,61.7077 -6.18888,8.114 -17.94958,11.45 -27.67313,7.8496 z m 1026.45978,-0.115 c -9.3509,-3.2832 -12.7775,-8.8915 -23.0406,-37.7113 -11.1871,-31.4141 -11.0231,-30.7541 -9.4166,-37.9043 3.3815,-15.0497 18.9787,-23.4458 32.8151,-17.6645 5.917,2.4722 10.5149,6.5637 13.2192,11.7632 2.9977,5.7635 20.4239,55.1177 20.4154,57.8199 -0.041,13.1944 -12.9026,25.8714 -25.9925,25.6206 -1.4667,-0.028 -5.0667,-0.8937 -8,-1.9236 z M 166.89103,1251.8057 c -7.30506,-3.6159 -12.43252,-11.1848 -13.21352,-19.5051 -0.49735,-5.2984 0.83269,-10.2242 8.36168,-30.9673 4.9242,-13.5666 10.05352,-26.8412 11.39848,-29.4989 5.02981,-9.9393 13.68416,-14.2147 25.97045,-12.8298 11.10139,1.2513 20.59188,12.1589 20.59188,23.6668 0,5.2044 -14.5714,47.901 -20.02001,58.6619 -6.18428,12.2139 -20.4496,16.7287 -33.08896,10.4724 z m 1244.44227,0.6407 c -9.3833,-4.9579 -10.396,-6.7603 -22.5048,-40.0552 -9.5964,-26.387 -10.4521,-31.9816 -6.1741,-40.3671 6.9099,-13.5445 26.1507,-17.9061 37.3648,-8.47 5.4279,4.5672 7.3752,8.6678 17.9416,37.7792 10.1051,27.8406 10.6259,32.9528 4.326,42.4724 -6.2893,9.5039 -21.3585,13.7104 -30.9535,8.6407 z"
                fill="currentColor"
                stroke="none"
            />
        </svg>
    );
}


function CodeModalButon({ buttonClass }: { buttonClass: string; }) {
    const buttonRef = useRef(null);
    const [show, setShow] = useState(false);

    return (
        <Popout
            position="bottom"
            align="right"
            animation={Popout.Animation.NONE}
            shouldShow={show}
            onRequestClose={() => setShow(false)}
            targetElementRef={buttonRef}
            renderPopout={() => BrawlhallaPopout(() => setShow(false))}
        >
            {(_, { isShown }) => (
                <HeaderBarIcon
                    ref={buttonRef}
                    className={`vc-brawlhalla-btn ${buttonClass}`}
                    onClick={() => setShow(v => !v)}
                    tooltip={isShown ? null : "Render Codes"}
                    icon={() => BrawlhallaPopoutIcon}
                    selected={isShown}
                />
            )}
        </Popout>
    );
}

export default definePlugin({
    name: "BrawlCode",
    description: "Mod to get notified when a brawlhalla code is sent",
    authors: [{
        name: "mr_shoco",
        id: 439129442972073984n
    }],
    settings,
    patches: [
        {
            find: '?"BACK_FORWARD_NAVIGATION":',
            replacement: {
                match: /(?<=trailing:.{0,50})\i\.Fragment,\{(?=.+?className:(\i))/,
                replace: "$self.TrailingWrapper,{className:$1,"
            }
        }
    ],
    TrailingWrapper({ children, className }: PropsWithChildren<{ className: string; }>) {
        return (
            <>
                {children}
                <ErrorBoundary noop>
                    <CodeModalButon buttonClass={className} />
                </ErrorBoundary>
            </>
        );
    },
    flux: {
        async MESSAGE_CREATE({ optimistic, type, message }: IMessageCreate): Promise<void> {

            // Environment
            const channel = ChannelStore.getChannel(message.channel_id);

            // Check if the message should be reviewed
            if (optimistic || type !== "MESSAGE_CREATE") return;
            if (message.state === "SENDING") return;
            if (message.author?.bot) return;
            if (!message.content) return;

            // Code check
            const lines = message.content
                .split(/\n/)
                .map(l => l.trim())
                .filter(Boolean);

            const CodesCollection: Record<string, string[]> = {};
            let currentHeader = "Unknown";

            for (const line of lines) {

                if (RegexCode.test(line)) {
                    if (!CodesCollection[currentHeader]) CodesCollection[currentHeader] = [];
                    CodesCollection[currentHeader].push(line);
                } else {
                    currentHeader = line;
                }
            }

            if (Object.keys(CodesCollection).length === 0) return; // Do not open modal if no codes were found

            lastCodesCollection = CodesCollection;
            // Code display
            if (!settings.store.openOnRecieve) return;
            openCodeModal(CodesCollection);

            // Play sound
            if (!settings.store.playSound) return;
            playModalSound();
        }
    },
});

function playModalSound() {
    let audio: HTMLAudioElement | null = null;

    switch (settings.store.soundToPlay) {
        case "default":
            audio = new Audio(modalSounds.default);
            break;

        case "trobbio":
            audio = new Audio(modalSounds.trobbio);
            break;

        default:
            break;
    }

    if (audio) {
        audio.play().catch(err => console.error("Erreur audio :", err));
    }
}

function openCodeModal(CodesCollection) {
    const AlertModal = require("./components/CodesModal").default;
    openModal(modalProps => (
        <AlertModal
            {...modalProps}
            CodesCollection={CodesCollection}
        />
    ));
}

function openLastCodeModal() {
    const CodesCollection = lastCodesCollection;
    const AlertModal = require("./components/CodesModal").default;
    openModal(modalProps => (
        <AlertModal
            {...modalProps}
            CodesCollection={CodesCollection}
        />
    ));
}
